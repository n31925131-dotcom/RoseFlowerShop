<!DOCTYPE html>
<html lang="el">
<head>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Διαχείριση Συλλογής - Rose Flower Shop</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: { extend: { fontFamily: { sans:['Inter','sans-serif'], serif:['Playfair Display','serif'] }, colors: { rose:{ 50:'#fff1f2',100:'#ffe4e6',200:'#fecdd3',600:'#e11d48',700:'#be123c' } } } }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        @keyframes slideIn{from{transform:translateX(100%)}to{transform:translateX(0)}}
        .fade-in{animation:fadeIn .5s ease-out forwards}
        .toast{position:fixed;top:20px;right:20px;z-index:9999;animation:slideIn .3s ease-out}
        .stagger-1{animation-delay:.05s;opacity:0}.stagger-2{animation-delay:.10s;opacity:0}
        .stagger-3{animation-delay:.15s;opacity:0}.stagger-4{animation-delay:.20s;opacity:0}
        .stagger-5{animation-delay:.25s;opacity:0}.stagger-6{animation-delay:.30s;opacity:0}
        .image-card:hover .delete-overlay{opacity:1!important}
        .delete-overlay{transition:opacity .3s ease}
    </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans min-h-screen">

<header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-20">
            <a href="index.html" class="flex items-center space-x-2">
                <span class="text-2xl font-serif font-bold text-rose-600">Rose</span>
                <span class="text-xl font-light text-gray-600">Flower Shop</span>
            </a>
            <nav class="hidden md:flex space-x-8 items-center">
                <a href="index.html" class="text-gray-700 hover:text-rose-600 transition font-medium">Αρχική</a>
                <a href="gallery-public.html" class="text-gray-700 hover:text-rose-600 transition font-medium">Συλλογή</a>
                <button id="logout-btn" class="bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">Αποσύνδεση</button>
            </nav>
            <button id="mobile-menu-button" class="md:hidden text-gray-600 hover:text-rose-600">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
            </button>
        </div>
    </div>
    <div id="mobile-menu" class="hidden md:hidden bg-white border-t">
        <div class="px-2 pt-2 pb-3 space-y-1">
            <a href="index.html" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-50">Αρχική</a>
            <button id="logout-btn-mobile" class="w-full text-left px-3 py-2 rounded-md text-base font-medium text-rose-600 hover:bg-gray-50">Αποσύνδεση</button>
        </div>
    </div>
</header>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-8">
        <a href="admin.html" class="inline-flex items-center text-gray-600 hover:text-rose-600 transition mb-4">
            <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i>Πίσω στη Διαχείριση
        </a>
        <h1 class="text-4xl font-serif font-bold text-gray-900 mb-2">Διαχείριση Συλλογής</h1>
        <p class="text-gray-600">Προσθέστε ή αφαιρέσετε εικόνες από τη συλλογή σας</p>
    </div>

    <!-- GitHub Token Banner -->
    <div id="token-banner" class="mb-6 bg-amber-50 border border-amber-200 rounded-2xl p-5 flex flex-col sm:flex-row sm:items-center gap-4">
        <div class="flex-1">
            <p class="font-semibold text-amber-800">⚙️ Σύνδεση με GitHub</p>
            <p class="text-sm text-amber-700 mt-1">Εισάγετε το GitHub Personal Access Token σας ώστε οι αλλαγές να είναι ορατές σε όλους τους επισκέπτες.</p>
        </div>
        <div class="flex gap-2 flex-shrink-0">
            <input type="password" id="github-token-input" placeholder="ghp_xxxxxxxxxxxx"
                class="px-3 py-2 border border-amber-300 rounded-lg text-sm w-52 focus:outline-none focus:ring-2 focus:ring-amber-400">
            <button id="save-token-btn" class="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition">Αποθήκευση</button>
        </div>
    </div>
    <div id="token-ok-banner" class="hidden mb-6 bg-green-50 border border-green-200 rounded-2xl p-4 flex items-center justify-between">
        <p class="text-green-800 text-sm font-medium">Token αποθηκεύτηκε — οι αλλαγές θα είναι ορατές σε όλους.</p>
        <button id="change-token-btn" class="text-green-700 underline text-sm ml-4">Αλλαγή</button>
    </div>

    <!-- Upload -->
    <div class="bg-rose-50 rounded-2xl p-6 mb-8">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Κατηγορία</label>
                <select id="category-select" class="w-full px-4 py-3 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-rose-500 focus:border-transparent transition">
                    <option value="Weddings">Γάμοι</option>
                    <option value="Baptisms">Βαπτίσεις</option>
                    <option value="Events">Εκδηλώσεις</option>
                    <option value="Bouquets">Μπουκέτα</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Ανέβασμα Εικόνων</label>
                <label class="flex items-center justify-center px-6 py-3 bg-rose-600 text-white rounded-lg hover:bg-rose-700 transition-colors cursor-pointer">
                    <i data-lucide="upload" class="w-5 h-5 mr-2"></i>
                    <span id="upload-text">Επιλογή Εικόνων</span>
                    <input type="file" id="file-input" class="hidden" multiple accept="image/*">
                </label>
            </div>
        </div>
    </div>

    <!-- Progress -->
    <div id="progress-container" class="hidden mb-6">
        <div class="flex justify-between text-sm text-gray-600 mb-1">
            <span id="progress-label">Ανέβασμα εικόνων...</span>
            <span id="progress-count">0 / 0</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
            <div id="progress-bar" class="bg-rose-600 h-2 rounded-full transition-all duration-300" style="width:0%"></div>
        </div>
    </div>

    <div id="loading-spinner" class="hidden flex justify-center items-center py-20">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-rose-600"></div>
    </div>
    <div id="empty-state" class="hidden bg-gray-50 rounded-2xl p-12 text-center">
        <i data-lucide="image" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
        <p class="text-gray-600">Δεν υπάρχουν εικόνες σε αυτή την κατηγορία</p>
    </div>
    <div id="images-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
</main>

<div id="toast-container"></div>

<script>
// ── CONFIG ──
const CLOUDINARY_CLOUD  = 'dopmj1ksm';
const CLOUDINARY_PRESET = 'flower_shop_preset';
const GITHUB_OWNER = 'n31925131-dotcom';
const GITHUB_REPO  = 'RoseFlowerShop';
const GITHUB_FILE  = 'gallery-data.json';
const RAW_URL = `https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/main/${GITHUB_FILE}`;

// Auth guard
if (sessionStorage.getItem('admin_auth') !== 'true') window.location.href = 'admin.html';

// Token helpers
function getToken() { return sessionStorage.getItem('github_token') || ''; }
function updateTokenUI() {
    const hasToken = !!getToken();
    document.getElementById('token-banner').classList.toggle('hidden', hasToken);
    document.getElementById('token-ok-banner').classList.toggle('hidden', !hasToken);
}

document.getElementById('save-token-btn').addEventListener('click', () => {
    const val = document.getElementById('github-token-input').value.trim();
    if (!val) return showToast('Εισάγετε ένα έγκυρο token', 'error');
    sessionStorage.setItem('github_token', val);
    updateTokenUI();
    showToast('Token αποθηκεύτηκε!', 'success');
});
document.getElementById('change-token-btn').addEventListener('click', () => {
    sessionStorage.removeItem('github_token');
    updateTokenUI();
});

function showToast(msg, type='success') {
    const c = document.getElementById('toast-container');
    const t = document.createElement('div');
    t.className = `toast px-6 py-4 rounded-lg shadow-lg text-white ${type==='success'?'bg-green-600':'bg-red-600'}`;
    t.textContent = msg;
    c.appendChild(t);
    setTimeout(() => { t.style.animation='slideIn .3s ease-out reverse'; setTimeout(()=>t.remove(),300); }, 3500);
}

function generateId() { return 'img_'+Date.now()+'_'+Math.random().toString(36).substr(2,9); }

// ── GITHUB DATA LAYER ──
async function loadGalleryData() {
    try {
        const res = await fetch(RAW_URL + '?t=' + Date.now());
        if (!res.ok) return [];
        return await res.json();
    } catch(e) { return []; }
}

async function saveGalleryData(images) {
    const token = getToken();
    if (!token) {
        localStorage.setItem('galleryImages', JSON.stringify(images));
        showToast('Χωρίς GitHub token — αποθηκεύτηκε μόνο τοπικά!', 'error');
        return false;
    }
    const apiUrl = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${GITHUB_FILE}`;
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(images, null, 2))));
    let sha = null;
    try {
        const info = await fetch(apiUrl, { headers:{ Authorization:`token ${token}` } });
        if (info.ok) { sha = (await info.json()).sha; }
    } catch(e) {}
    const body = { message:'Update gallery data', content, ...(sha?{sha}:{}) };
    const res = await fetch(apiUrl, {
        method:'PUT',
        headers:{ Authorization:`token ${token}`, 'Content-Type':'application/json' },
        body: JSON.stringify(body)
    });
    if (!res.ok) {
        const err = await res.json();
        showToast('GitHub σφάλμα: ' + (err.message||'unknown'), 'error');
        return false;
    }
    return true;
}

// ── RENDER ──
let allImages = [];
function renderImages() {
    const category = document.getElementById('category-select').value;
    const filtered = allImages.filter(img => img.category === category);
    const grid = document.getElementById('images-grid');
    const empty = document.getElementById('empty-state');
    if (filtered.length === 0) {
        grid.innerHTML = '';
        empty.classList.remove('hidden');
    } else {
        empty.classList.add('hidden');
        grid.innerHTML = filtered.map((img, i) => `
            <div class="image-card relative aspect-square rounded-xl overflow-hidden shadow-lg fade-in stagger-${(i%6)+1} group">
                <img src="${img.image_url}" alt="Gallery Image" class="w-full h-full object-cover">
                <div class="delete-overlay absolute inset-0 bg-black/50 opacity-0 flex items-center justify-center">
                    <button onclick="deleteImage('${img.id}')"
                        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center space-x-2">
                        <i data-lucide="trash-2" class="w-4 h-4"></i><span>Διαγραφή</span>
                    </button>
                </div>
            </div>`).join('');
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }
}

// ── UPLOAD ──
async function uploadToCloudinary(file) {
    const fd = new FormData();
    fd.append('file', file);
    fd.append('upload_preset', CLOUDINARY_PRESET);
    const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD}/image/upload`, { method:'POST', body:fd });
    if (!res.ok) { const e=await res.json(); throw new Error(e.error?.message||'Upload failed'); }
    return (await res.json()).secure_url;
}

async function handleFileUpload(event) {
    const files = Array.from(event.target.files);
    if (!files.length) return;
    const category = document.getElementById('category-select').value;
    const uploadText = document.getElementById('upload-text');
    const prog = document.getElementById('progress-container');
    const bar  = document.getElementById('progress-bar');
    const cnt  = document.getElementById('progress-count');
    const lbl  = document.getElementById('progress-label');

    uploadText.textContent = 'Ανέβασμα...';
    prog.classList.remove('hidden');
    cnt.textContent = `0 / ${files.length}`;
    bar.style.width = '0%';
    lbl.textContent = 'Ανέβασμα εικόνων στο Cloudinary...';

    let done = 0;
    const newImages = [...allImages];
    for (const file of files) {
        try {
            const url = await uploadToCloudinary(file);
            newImages.push({ id:generateId(), created_date:new Date().toISOString(), category, image_url:url });
            done++;
            cnt.textContent = `${done} / ${files.length}`;
            bar.style.width = `${Math.round(done/files.length*100)}%`;
        } catch(e) { showToast('Σφάλμα upload: '+e.message, 'error'); }
    }

    lbl.textContent = 'Αποθήκευση στο GitHub...';
    const ok = await saveGalleryData(newImages);
    if (ok) { allImages = newImages; showToast(`${done} εικόνες ανέβηκαν επιτυχώς!`, 'success'); }

    renderImages();
    uploadText.textContent = 'Επιλογή Εικόνων';
    prog.classList.add('hidden');
    event.target.value = '';
}

// ── DELETE ──
async function deleteImage(imageId) {
    if (!confirm('Είστε σίγουροι ότι θέλετε να διαγράψετε αυτή την εικόνα;')) return;
    const updated = allImages.filter(img => img.id !== imageId);
    const ok = await saveGalleryData(updated);
    if (ok) { allImages = updated; showToast('Εικόνα διαγράφηκε!', 'success'); renderImages(); }
}
window.deleteImage = deleteImage;

// ── EVENTS ──
document.getElementById('category-select').addEventListener('change', renderImages);
document.getElementById('file-input').addEventListener('change', handleFileUpload);
document.getElementById('mobile-menu-button').addEventListener('click', () =>
    document.getElementById('mobile-menu').classList.toggle('hidden'));
function handleLogout() { sessionStorage.clear(); window.location.href = 'admin.html'; }
document.getElementById('logout-btn').addEventListener('click', handleLogout);
document.getElementById('logout-btn-mobile').addEventListener('click', handleLogout);

// ── INIT ──
window.addEventListener('DOMContentLoaded', async () => {
    updateTokenUI();
    if (typeof lucide !== 'undefined') lucide.createIcons();
    document.getElementById('loading-spinner').classList.remove('hidden');
    allImages = await loadGalleryData();
    document.getElementById('loading-spinner').classList.add('hidden');
    renderImages();
});
</script>
</body>
</html>
